name: üöÄ Workflow Installer

on:
  workflow_dispatch:
    inputs:
      target_repos:
        description: 'Comma-separated list of repos to install workflows (e.g., "repo1,repo2,org/repo3")'
        required: true
        type: string
      workflows:
        description: 'Which workflows to install'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - issue-quality-enhancer
          - smart-labeler
          - the-suggester-discussion-mode
          - label-beautifier
          - continuous-docs
      create_pr:
        description: 'Create a PR instead of pushing directly to main'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

jobs:
  install:
    name: üöÄ Install Workflows
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üöÄ Install caller workflows to target repos
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          TARGET_REPOS: ${{ inputs.target_repos }}
          WORKFLOWS: ${{ inputs.workflows }}
          CREATE_PR: ${{ inputs.create_pr }}
        run: |
          OWNER="0GiS0"

          # Determine which workflow files to install
          if [ "$WORKFLOWS" = "all" ]; then
            FILES=$(ls caller-workflows/*.yml)
          else
            FILES="caller-workflows/${WORKFLOWS}.yml"
          fi

          # Process each target repo
          IFS=',' read -ra REPOS <<< "$TARGET_REPOS"
          for REPO in "${REPOS[@]}"; do
            REPO=$(echo "$REPO" | xargs) # trim whitespace

            # Strip GitHub URL prefixes if provided (e.g., https://github.com/owner/repo)
            REPO="${REPO#https://github.com/}"
            REPO="${REPO#http://github.com/}"
            REPO="${REPO#github.com/}"
            REPO="${REPO%/}" # remove trailing slash

            # Add owner if not specified
            if [[ "$REPO" != *"/"* ]]; then
              REPO="${OWNER}/${REPO}"
            fi

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üì¶ Installing workflows to: $REPO"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            if [ "$CREATE_PR" = "true" ]; then
              # Create a branch for the PR
              BRANCH="agentic-workflows/install-$(date +%Y%m%d%H%M%S)"
              DEFAULT_BRANCH=$(gh api "repos/${REPO}" --jq '.default_branch')

              # Get the SHA of the default branch
              SHA=$(gh api "repos/${REPO}/git/ref/heads/${DEFAULT_BRANCH}" --jq '.object.sha')

              # Create the new branch
              gh api "repos/${REPO}/git/refs" \
                -f ref="refs/heads/${BRANCH}" \
                -f sha="${SHA}" || {
                echo "‚ùå Failed to create branch in $REPO"
                continue
              }
              echo "üåø Created branch: $BRANCH"
            fi

            TARGET_BRANCH="${BRANCH:-main}"
            
            # Track what we did for the PR description
            INSTALLED_NEW=""
            CONVERTED=""
            ALREADY_CALLER=""

            for FILE in $FILES; do
              FILENAME=$(basename "$FILE")
              CONTENT=$(base64 "$FILE" | tr -d '\n')
              TARGET_PATH=".github/workflows/${FILENAME}"

              echo "  üìÑ Processing: $TARGET_PATH (base64 length: ${#CONTENT})"

              # Check if file already exists and analyze its content
              EXISTING_JSON=$(gh api "repos/${REPO}/contents/${TARGET_PATH}?ref=${TARGET_BRANCH}" 2>/dev/null || echo "")
              EXISTING_CONTENT=$(echo "$EXISTING_JSON" | jq -r '.content // empty' 2>/dev/null | tr -d '\n' | base64 -d 2>/dev/null || echo "")
              EXISTING_SHA=$(echo "$EXISTING_JSON" | jq -r '.sha // empty' 2>/dev/null || echo "")

              # Build the JSON payload in a temp file
              PAYLOAD_FILE=$(mktemp)

              if [ -n "$EXISTING_CONTENT" ]; then
                # Check if it's already a caller (uses reusable workflow)
                if echo "$EXISTING_CONTENT" | grep -q "uses: ${OWNER}/agentic-repo/"; then
                  echo "  ‚è≠Ô∏è  Already using reusable workflow, skipping: $FILENAME"
                  ALREADY_CALLER="${ALREADY_CALLER}\n- **${FILENAME%.yml}** ‚Äî already centralized ‚úÖ"
                  rm -f "$PAYLOAD_FILE"
                  continue
                fi

                # Check if it's a full workflow (contains copilot -p or the main logic)
                if echo "$EXISTING_CONTENT" | grep -q "copilot -p\|Install GitHub Copilot CLI"; then
                  echo "  üîÑ Converting full workflow to caller: $FILENAME"
                  COMMIT_MSG="üîÑ Convert ${FILENAME} to use centralized reusable workflow from agentic-repo"
                else
                  echo "  üí° Updating existing workflow: $FILENAME"
                  COMMIT_MSG="ü§ñ Update ${FILENAME} from agentic-repo"
                fi

                jq -n \
                  --arg message "$COMMIT_MSG" \
                  --arg content "$CONTENT" \
                  --arg sha "$EXISTING_SHA" \
                  --arg branch "$TARGET_BRANCH" \
                  '{message: $message, content: $content, sha: $sha, branch: $branch}' > "$PAYLOAD_FILE"
                HTTP_STATUS=$(curl -s -o /tmp/api_response.json -w "%{http_code}" \
                  -X PUT \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Content-Type: application/json" \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  -d @"$PAYLOAD_FILE" \
                  "https://api.github.com/repos/${REPO}/contents/${TARGET_PATH}")
                if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "201" ]]; then
                  if echo "$EXISTING_CONTENT" | grep -q "copilot -p\|Install GitHub Copilot CLI"; then
                    echo "  ‚úÖ Converted: $FILENAME ‚Üí now uses centralized workflow"
                    CONVERTED="${CONVERTED}\n- **${FILENAME%.yml}** ‚Äî converted from full workflow to caller"
                  else
                    echo "  ‚úÖ Updated: $FILENAME"
                    INSTALLED_NEW="${INSTALLED_NEW}\n- **${FILENAME%.yml}** ‚Äî updated"
                  fi
                else
                  echo "  ‚ùå Failed to update $FILENAME in $REPO (HTTP $HTTP_STATUS)"
                  cat /tmp/api_response.json
                fi
              else
                # Create new file
                jq -n \
                  --arg message "ü§ñ Install ${FILENAME} from agentic-repo" \
                  --arg content "$CONTENT" \
                  --arg branch "$TARGET_BRANCH" \
                  '{message: $message, content: $content, branch: $branch}' > "$PAYLOAD_FILE"
                HTTP_STATUS=$(curl -s -o /tmp/api_response.json -w "%{http_code}" \
                  -X PUT \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Content-Type: application/json" \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  -d @"$PAYLOAD_FILE" \
                  "https://api.github.com/repos/${REPO}/contents/${TARGET_PATH}")
                if [[ "$HTTP_STATUS" == "200" || "$HTTP_STATUS" == "201" ]]; then
                  echo "  ‚úÖ Installed: $FILENAME"
                  INSTALLED_NEW="${INSTALLED_NEW}\n- **${FILENAME%.yml}** ‚Äî newly installed"
                else
                  echo "  ‚ùå Failed to create $FILENAME in $REPO (HTTP $HTTP_STATUS)"
                  cat /tmp/api_response.json
                fi
              fi

              rm -f "$PAYLOAD_FILE"
            done

            if [ "$CREATE_PR" = "true" ]; then
              # Build PR body based on what we did
              PR_BODY="## üöÄ Agentic Workflows Installation & Centralization"
              PR_BODY="${PR_BODY}"$'\n\n'"This PR installs/converts workflows to use reusable workflow callers from [\`agentic-repo\`](https://github.com/${OWNER}/agentic-repo)."
              PR_BODY="${PR_BODY}"$'\n\n'"### üìã Changes Summary"

              if [ -n "$CONVERTED" ]; then
                PR_BODY="${PR_BODY}"$'\n\n'"#### üîÑ Converted to Centralized Workflows"
                PR_BODY="${PR_BODY}"$'\n'"These workflows were converted from full standalone workflows to lightweight callers that reference the central \`agentic-repo\`:"
                PR_BODY="${PR_BODY}"$'\n'"$(echo -e "$CONVERTED")"
              fi

              if [ -n "$INSTALLED_NEW" ]; then
                PR_BODY="${PR_BODY}"$'\n\n'"#### ‚ú® Newly Installed"
                PR_BODY="${PR_BODY}"$'\n'"$(echo -e "$INSTALLED_NEW")"
              fi

              if [ -n "$ALREADY_CALLER" ]; then
                PR_BODY="${PR_BODY}"$'\n\n'"#### ‚è≠Ô∏è Already Centralized (no changes)"
                PR_BODY="${PR_BODY}"$'\n'"$(echo -e "$ALREADY_CALLER")"
              fi

              PR_BODY="${PR_BODY}"$'\n\n'"### üéØ Benefits of Centralization"
              PR_BODY="${PR_BODY}"$'\n'"- **Single source of truth**: All logic lives in \`agentic-repo\`"
              PR_BODY="${PR_BODY}"$'\n'"- **Automatic updates**: When we improve workflows, all repos benefit instantly"
              PR_BODY="${PR_BODY}"$'\n'"- **Smaller files**: Caller workflows are ~15 lines vs hundreds"
              PR_BODY="${PR_BODY}"$'\n'"- **Consistency**: Same behavior across all your repositories"
              PR_BODY="${PR_BODY}"$'\n\n'"### ‚ö†Ô∏è Required Setup"
              PR_BODY="${PR_BODY}"$'\n'"- Add a \`COPILOT_PAT\` secret to this repository with a GitHub PAT that has Copilot access"
              PR_BODY="${PR_BODY}"$'\n\n'"---"
              PR_BODY="${PR_BODY}"$'\n'"> ü§ñ *This PR was automatically created by the [Workflow Installer](https://github.com/${OWNER}/agentic-repo)*"

              # Create PR
              PR_URL=$(gh pr create \
                --repo "$REPO" \
                --base "$DEFAULT_BRANCH" \
                --head "$BRANCH" \
                --title "ü§ñ Centralize agentic workflows from agentic-repo" \
                --body "$PR_BODY" 2>&1) || {
                echo "‚ùå Failed to create PR in $REPO"
                continue
              }
              echo "üéâ PR created: $PR_URL"
            fi

            echo ""
          done

          echo "‚úÖ Installation & centralization completed!"
